<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Penilaian Teknisi</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      max-width: 350px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .toast.info { background: #3b82f6; }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .fade-out {
      animation: slideOut 0.3s ease-out forwards;
    }

    .card-hover {
      transition: all 0.3s ease;
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 16px rgba(124, 58, 237, 0.3);
    }

    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #7c3aed;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .sidebar-fixed {
      position: fixed;
      height: 100%;
      overflow-y: auto;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }

    .gradient-card {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full">
  <div id="app" class="min-h-full"></div>
  <script>
    const defaultConfig = {
      app_title: "Sistem Penilaian Teknisi",
      welcome_message: "Selamat Datang",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      background_color: "#f8f9ff",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      font_family: "system-ui",
      font_size: 16
    };

    let appState = {
      currentUser: null,
      currentView: 'login',
      users: [],
      criteria: [],
      assessments: [],
      technicians: []
    };

    let adminActiveTab = 'dashboard';
    let supervisorActiveTab = 'dashboard';
    let tempSubItems = [];

    const dataHandler = {
      onDataChanged(data) {
        appState.users = data.filter(d => d.type === 'user');
        appState.criteria = data.filter(d => d.type === 'criteria');
        appState.assessments = data.filter(d => d.type === 'assessment');
        
        appState.technicians = appState.users.filter(u => u.role === 'teknisi');
        
        render();
      }
    };

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function showLoading(button) {
      button.disabled = true;
      const originalText = button.textContent;
      button.innerHTML = '<div class="loading-spinner inline-block"></div>';
      return () => {
        button.disabled = false;
        button.textContent = originalText;
      };
    }

    let adminCreationAttempted = false;
    let sidebarCollapsed = false;

    async function createDefaultAdmin() {
      if (adminCreationAttempted) return;
      
      await new Promise(resolve => setTimeout(resolve, 500));

      const existingAdmin = appState.users.find(u => u.role === 'admin' && u.username === 'admin');
      
      if (!existingAdmin) {
        adminCreationAttempted = true;
        const adminResult = await window.dataSdk.create({
          type: 'user',
          username: 'admin',
          password: 'admin123',
          name: 'Administrator',
          email: 'admin@system.com',
          group: 'Management',
          position: 'System Administrator',
          nik: 'ADM001',
          role: 'admin',
          createdAt: new Date().toISOString()
        });
      } else {
        adminCreationAttempted = true;
      }
    }

    async function initializeApp() {
      const result = await window.dataSdk.init(dataHandler);
      
      if (!result.isOk) {
        showToast('Gagal menginisialisasi aplikasi', 'error');
        return;
      }

      createDefaultAdmin();
    }

    async function handleLogin(e) {
      e.preventDefault();
      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      await new Promise(resolve => setTimeout(resolve, 500));

      const user = appState.users.find(u => u.username === username && u.password === password);

      hideLoading();

      if (user) {
        appState.currentUser = user;
        
        if (user.role === 'admin') {
          appState.currentView = 'admin-dashboard';
          adminActiveTab = 'dashboard';
        } else if (user.role === 'supervisor') {
          appState.currentView = 'supervisor-dashboard';
          supervisorActiveTab = 'dashboard';
        } else if (user.role === 'admin_viewer') {
          appState.currentView = 'admin-viewer-dashboard';
        } else if (user.role === 'teknisi') {
          appState.currentView = 'teknisi-dashboard';
        }
        
        render();
        showToast(`Selamat datang, ${user.name}!`, 'success');
      } else {
        showToast('Username atau password salah', 'error');
      }
    }

    function handleLogout() {
      appState.currentUser = null;
      appState.currentView = 'login';
      adminActiveTab = 'dashboard';
      supervisorActiveTab = 'dashboard';
      showToast('Berhasil logout', 'info');
      render();
    }

    async function handleAddUser(e) {
      e.preventDefault();
      
      if (appState.users.length >= 999) {
        showToast('Maksimum 999 user tercapai', 'error');
        return;
      }

      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const formData = new FormData(e.target);
      const username = formData.get('username');
      const existingUser = appState.users.find(u => u.username === username);
      
      if (existingUser) {
        hideLoading();
        showToast('Username sudah digunakan', 'error');
        return;
      }

      const result = await window.dataSdk.create({
        type: 'user',
        username: username,
        password: formData.get('password'),
        name: formData.get('name'),
        email: formData.get('email') || '',
        group: formData.get('group') || '',
        position: formData.get('position') || '',
        nik: formData.get('nik') || '',
        role: formData.get('role'),
        createdAt: new Date().toISOString()
      });

      hideLoading();

      if (result.isOk) {
        showToast('User berhasil ditambahkan', 'success');
        document.getElementById('add-user-modal').classList.add('hidden');
        e.target.reset();
      } else {
        showToast('Gagal menambahkan user', 'error');
      }
    }

    async function handleAddTechnician(e) {
      e.preventDefault();
      
      if (appState.users.length >= 999) {
        showToast('Maksimum 999 user tercapai', 'error');
        return;
      }

      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const formData = new FormData(e.target);
      const username = formData.get('username');
      const email = formData.get('email');
      const nik = formData.get('nik');
      
      const existingUser = appState.users.find(u => u.username === username);
      if (existingUser) {
        hideLoading();
        showToast('Username sudah digunakan', 'error');
        return;
      }

      const existingEmail = appState.users.find(u => u.email === email && u.email !== '');
      if (existingEmail) {
        hideLoading();
        showToast('Email sudah digunakan', 'error');
        return;
      }

      const existingNik = appState.users.find(u => u.nik === nik && u.nik !== '');
      if (existingNik) {
        hideLoading();
        showToast('NIK sudah digunakan', 'error');
        return;
      }

      const result = await window.dataSdk.create({
        type: 'user',
        username: username,
        password: formData.get('password'),
        name: formData.get('name'),
        email: email,
        group: formData.get('group'),
        position: formData.get('position'),
        nik: nik,
        role: 'teknisi',
        createdAt: new Date().toISOString()
      });

      hideLoading();

      if (result.isOk) {
        showToast('Teknisi berhasil ditambahkan', 'success');
        document.getElementById('add-technician-modal').classList.add('hidden');
        e.target.reset();
      } else {
        showToast('Gagal menambahkan teknisi', 'error');
      }
    }

    function openEditUser(user) {
      editingUser = user;
      document.getElementById('edit-user-modal').classList.remove('hidden');
      document.getElementById('edit-user-name').value = user.name;
      document.getElementById('edit-user-username').value = user.username;
      document.getElementById('edit-user-role').value = user.role;
    }

    async function handleEditUser(e) {
      e.preventDefault();
      
      if (!editingUser) return;

      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const formData = new FormData(e.target);
      
      editingUser.name = formData.get('name');
      editingUser.username = formData.get('username');
      editingUser.role = formData.get('role');
      
      const password = formData.get('password');
      if (password) {
        editingUser.password = password;
      }

      const result = await window.dataSdk.update(editingUser);

      hideLoading();

      if (result.isOk) {
        showToast('User berhasil diupdate', 'success');
        document.getElementById('edit-user-modal').classList.add('hidden');
        editingUser = null;
      } else {
        showToast('Gagal mengupdate user', 'error');
      }
    }

    function openEditTechnician(tech) {
      editingTechnician = tech;
      document.getElementById('edit-technician-modal').classList.remove('hidden');
      document.getElementById('edit-tech-name').value = tech.name;
      document.getElementById('edit-tech-username').value = tech.username;
      document.getElementById('edit-tech-email').value = tech.email || '';
      document.getElementById('edit-tech-nik').value = tech.nik || '';
      document.getElementById('edit-tech-group').value = tech.group || '';
      document.getElementById('edit-tech-position').value = tech.position || '';
    }

    async function handleEditTechnician(e) {
      e.preventDefault();
      
      if (!editingTechnician) return;

      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const formData = new FormData(e.target);
      
      editingTechnician.name = formData.get('name');
      editingTechnician.username = formData.get('username');
      editingTechnician.email = formData.get('email');
      editingTechnician.nik = formData.get('nik');
      editingTechnician.group = formData.get('group');
      editingTechnician.position = formData.get('position');
      
      const password = formData.get('password');
      if (password) {
        editingTechnician.password = password;
      }

      const result = await window.dataSdk.update(editingTechnician);

      hideLoading();

      if (result.isOk) {
        showToast('Teknisi berhasil diupdate', 'success');
        document.getElementById('edit-technician-modal').classList.add('hidden');
        editingTechnician = null;
      } else {
        showToast('Gagal mengupdate teknisi', 'error');
      }
    }

    async function handleDeleteUser(user) {
      const confirmBtn = event.target;
      const originalText = confirmBtn.textContent;
      
      if (originalText !== 'Konfirmasi Hapus?') {
        confirmBtn.textContent = 'Konfirmasi Hapus?';
        confirmBtn.classList.add('bg-red-700');
        
        setTimeout(() => {
          confirmBtn.textContent = originalText;
          confirmBtn.classList.remove('bg-red-700');
        }, 3000);
        return;
      }

      const hideLoading = showLoading(confirmBtn);
      
      const result = await window.dataSdk.delete(user);

      hideLoading();

      if (result.isOk) {
        showToast('User berhasil dihapus', 'success');
      } else {
        showToast('Gagal menghapus user', 'error');
      }
    }

    function addSubItem() {
      const name = document.getElementById('sub-item-name').value;
      const points = Number(document.getElementById('sub-item-points').value);
      
      if (!name || !points) {
        showToast('Nama dan poin sub-item harus diisi', 'error');
        return;
      }

      if (points > 10) {
        showToast('Maksimal poin per item adalah 10', 'error');
        return;
      }

      const currentTotal = tempSubItems.reduce((sum, item) => sum + item.points, 0);
      if (currentTotal + points > 10) {
        showToast(`Total poin tidak boleh melebihi 10. Saat ini: ${currentTotal} poin. Kurangi poin item lain terlebih dahulu.`, 'error');
        return;
      }

      tempSubItems.push({ name, points });
      document.getElementById('sub-item-name').value = '';
      document.getElementById('sub-item-points').value = '';
      
      renderSubItemsList();
    }

    function removeSubItem(index) {
      tempSubItems.splice(index, 1);
      renderSubItemsList();
    }

    function addEditSubItem() {
      const name = document.getElementById('edit-sub-item-name').value;
      const points = Number(document.getElementById('edit-sub-item-points').value);
      
      if (!name || !points) {
        showToast('Nama dan poin sub-item harus diisi', 'error');
        return;
      }

      if (points > 10) {
        showToast('Maksimal poin per item adalah 10', 'error');
        return;
      }

      const currentTotal = editTempSubItems.reduce((sum, item) => sum + item.points, 0);
      if (currentTotal + points > 10) {
        showToast(`Total poin tidak boleh melebihi 10. Saat ini: ${currentTotal} poin. Kurangi poin item lain terlebih dahulu.`, 'error');
        return;
      }

      editTempSubItems.push({ name, points });
      document.getElementById('edit-sub-item-name').value = '';
      document.getElementById('edit-sub-item-points').value = '';
      
      renderEditSubItemsList();
    }

    function removeEditSubItem(index) {
      editTempSubItems.splice(index, 1);
      renderEditSubItemsList();
    }

    function renderEditSubItemsList() {
      const container = document.getElementById('edit-sub-items-list');
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const textColor = config.text_color || defaultConfig.text_color;
      
      if (editTempSubItems.length === 0) {
        container.innerHTML = '<p class="text-center opacity-60 py-4" style="font-size: ' + (baseSize * 0.875) + 'px; color: ' + textColor + ';">Belum ada sub-item</p>';
        return;
      }

      const totalPoints = editTempSubItems.reduce((sum, item) => sum + item.points, 0);

      container.innerHTML = `
        <div class="mb-4 p-4 rounded-lg border-2 border-purple-200 gradient-card">
          <p class="font-semibold" style="font-size: ${baseSize}px; color: ${textColor};">Total Maksimal: ${totalPoints} poin</p>
        </div>
        ${editTempSubItems.map((item, index) => `
          <div class="flex justify-between items-center p-3 rounded-lg border-2 border-gray-100 mb-2">
            <div>
              <p class="font-medium" style="font-size: ${baseSize}px; color: ${textColor};">${item.name}</p>
              <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${item.points} poin</p>
            </div>
            <button type="button" onclick="removeEditSubItem(${index})" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors">
              Hapus
            </button>
          </div>
        `).join('')}
      `;
    }

    function openEditCriteria(criteria) {
      editingCriteria = criteria;
      editTempSubItems = JSON.parse(criteria.subItems);
      
      document.getElementById('edit-criteria-modal').classList.remove('hidden');
      document.getElementById('edit-criteria-name').value = criteria.criteriaName;
      document.getElementById('edit-criteria-description').value = criteria.description || '';
      
      renderEditSubItemsList();
    }

    async function handleEditCriteria(e) {
      e.preventDefault();
      
      if (!editingCriteria) return;

      if (editTempSubItems.length === 0) {
        showToast('Minimal harus ada 1 sub-item', 'error');
        return;
      }

      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const formData = new FormData(e.target);
      const maxPoints = editTempSubItems.reduce((sum, item) => sum + item.points, 0);
      
      editingCriteria.criteriaName = formData.get('criteriaName');
      editingCriteria.description = formData.get('description');
      editingCriteria.subItems = JSON.stringify(editTempSubItems);
      editingCriteria.maxPoints = maxPoints;

      const result = await window.dataSdk.update(editingCriteria);

      hideLoading();

      if (result.isOk) {
        showToast('Kriteria berhasil diupdate', 'success');
        document.getElementById('edit-criteria-modal').classList.add('hidden');
        editingCriteria = null;
        editTempSubItems = [];
      } else {
        showToast('Gagal mengupdate kriteria', 'error');
      }
    }

    function renderSubItemsList() {
      const container = document.getElementById('sub-items-list');
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const textColor = config.text_color || defaultConfig.text_color;
      
      if (tempSubItems.length === 0) {
        container.innerHTML = '<p class="text-center opacity-60 py-4" style="font-size: ' + (baseSize * 0.875) + 'px; color: ' + textColor + ';">Belum ada sub-item</p>';
        return;
      }

      const totalPoints = tempSubItems.reduce((sum, item) => sum + item.points, 0);

      container.innerHTML = `
        <div class="mb-4 p-4 rounded-lg border-2 border-purple-200 gradient-card">
          <p class="font-semibold" style="font-size: ${baseSize}px; color: ${textColor};">Total Maksimal: ${totalPoints} poin</p>
        </div>
        ${tempSubItems.map((item, index) => `
          <div class="flex justify-between items-center p-3 rounded-lg border-2 border-gray-100 mb-2">
            <div>
              <p class="font-medium" style="font-size: ${baseSize}px; color: ${textColor};">${item.name}</p>
              <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${item.points} poin</p>
            </div>
            <button type="button" onclick="removeSubItem(${index})" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors">
              Hapus
            </button>
          </div>
        `).join('')}
      `;
    }

    async function handleAddCriteria(e) {
      e.preventDefault();
      
      if (appState.criteria.length >= 999) {
        showToast('Maksimum 999 kriteria tercapai', 'error');
        return;
      }

      if (tempSubItems.length === 0) {
        showToast('Minimal harus ada 1 sub-item', 'error');
        return;
      }

      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const formData = new FormData(e.target);
      const maxPoints = tempSubItems.reduce((sum, item) => sum + item.points, 0);
      
      const result = await window.dataSdk.create({
        type: 'criteria',
        criteriaName: formData.get('criteriaName'),
        maxPoints: maxPoints,
        description: formData.get('description'),
        subItems: JSON.stringify(tempSubItems),
        createdAt: new Date().toISOString()
      });

      hideLoading();

      if (result.isOk) {
        showToast('Kriteria berhasil ditambahkan', 'success');
        document.getElementById('add-criteria-modal').classList.add('hidden');
        tempSubItems = [];
        e.target.reset();
        renderSubItemsList();
      } else {
        showToast('Gagal menambahkan kriteria', 'error');
      }
    }

    async function handleDeleteCriteria(criteria) {
      const confirmBtn = event.target;
      const originalText = confirmBtn.textContent;
      
      if (originalText !== 'Konfirmasi Hapus?') {
        confirmBtn.textContent = 'Konfirmasi Hapus?';
        confirmBtn.classList.add('bg-red-700');
        
        setTimeout(() => {
          confirmBtn.textContent = originalText;
          confirmBtn.classList.remove('bg-red-700');
        }, 3000);
        return;
      }

      const hideLoading = showLoading(confirmBtn);
      
      const result = await window.dataSdk.delete(criteria);

      hideLoading();

      if (result.isOk) {
        showToast('Kriteria berhasil dihapus', 'success');
      } else {
        showToast('Gagal menghapus kriteria', 'error');
      }
    }

    let selectedCriteriaForAssessment = null;
    let editingTechnician = null;
    let editingCriteria = null;
    let editTempSubItems = [];
    let editingUser = null;

    async function handleAddAssessment(e) {
      e.preventDefault();
      
      if (appState.assessments.length >= 999) {
        showToast('Maksimum 999 penilaian tercapai', 'error');
        return;
      }

      if (!selectedCriteriaForAssessment) {
        showToast('Silakan pilih kriteria penilaian', 'error');
        return;
      }

      const hideLoading = showLoading(e.target.querySelector('button[type="submit"]'));
      
      const formData = new FormData(e.target);
      const criteria = appState.criteria.find(c => c.__backendId === selectedCriteriaForAssessment);
      const subItems = JSON.parse(criteria.subItems);
      
      const checkedItems = [];
      let totalScore = 0;
      
      subItems.forEach((item, index) => {
        const isChecked = formData.get(`subitem_${index}`) === 'on';
        checkedItems.push({
          name: item.name,
          points: item.points,
          checked: isChecked
        });
        
        if (isChecked) {
          totalScore += item.points;
        }
      });

      const techId = formData.get('technicianId');
      const technician = appState.users.find(u => u.__backendId === techId);

      const result = await window.dataSdk.create({
        type: 'assessment',
        technicianId: techId,
        technicianName: technician ? technician.name : '',
        supervisorId: appState.currentUser.__backendId,
        supervisorName: appState.currentUser.name,
        criteriaId: criteria.__backendId,
        criteriaName: criteria.criteriaName,
        checkedItems: JSON.stringify(checkedItems),
        totalScore: totalScore,
        maxPossible: criteria.maxPoints,
        notes: formData.get('notes'),
        createdAt: new Date().toISOString()
      });

      hideLoading();

      if (result.isOk) {
        showToast('Penilaian berhasil disimpan', 'success');
        selectedCriteriaForAssessment = null;
        appState.currentView = 'supervisor-dashboard';
        supervisorActiveTab = 'assessments';
        render();
      } else {
        showToast('Gagal menyimpan penilaian', 'error');
      }
    }

    async function handleDeleteAssessment(assessment) {
      const confirmBtn = event.target;
      const originalText = confirmBtn.textContent;
      
      if (originalText !== 'Konfirmasi Hapus?') {
        confirmBtn.textContent = 'Konfirmasi Hapus?';
        confirmBtn.classList.add('bg-red-700');
        
        setTimeout(() => {
          confirmBtn.textContent = originalText;
          confirmBtn.classList.remove('bg-red-700');
        }, 3000);
        return;
      }

      const hideLoading = showLoading(confirmBtn);
      
      const result = await window.dataSdk.delete(assessment);

      hideLoading();

      if (result.isOk) {
        showToast('Penilaian berhasil dihapus', 'success');
      } else {
        showToast('Gagal menghapus penilaian', 'error');
      }
    }

    function downloadPDF() {
      showToast('Fitur download PDF akan segera tersedia', 'info');
    }

    function selectTechnician(id, name) {
      document.getElementById('tech-search').value = name;
      document.getElementById('tech-id').value = id;
      document.getElementById('tech-dropdown').classList.add('hidden');
    }

    function filterTechnicians(query) {
      const dropdown = document.getElementById('tech-dropdown');
      const options = dropdown.querySelectorAll('.tech-option');
      const searchLower = query.toLowerCase();
      
      let hasVisible = false;
      options.forEach(option => {
        const name = option.dataset.name.toLowerCase();
        if (name.includes(searchLower)) {
          option.style.display = 'block';
          hasVisible = true;
        } else {
          option.style.display = 'none';
        }
      });
      
      dropdown.classList.remove('hidden');
    }

    function selectCriteriaForAssessment(criteriaId) {
      const criteria = appState.criteria.find(c => c.__backendId === criteriaId);
      if (!criteria) return;

      selectedCriteriaForAssessment = criteriaId;
      document.getElementById('criteria-search').value = criteria.criteriaName;
      document.getElementById('criteria-dropdown').classList.add('hidden');
      
      displayCriteriaCheckboxes(criteria);
    }

    function displayCriteriaCheckboxes(criteria) {
      const container = document.getElementById('criteria-checkboxes-container');
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      const subItems = JSON.parse(criteria.subItems);

      container.innerHTML = `
        <div class="space-y-3">
          <div class="flex justify-between items-center mb-4 p-4 rounded-lg gradient-card">
            <h4 class="font-semibold" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">Centang Item Yang Sesuai</h4>
            <span class="font-semibold opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Total Maksimal: ${criteria.maxPoints} poin</span>
          </div>
          ${subItems.map((item, index) => `
            <div class="p-4 rounded-lg border-2 border-gray-200 hover:border-purple-300 transition-colors" style="background: ${bgColor};">
              <label class="flex items-start gap-3 cursor-pointer">
                <input type="checkbox" name="subitem_${index}" 
                  class="mt-1 w-5 h-5 rounded border-2 border-gray-300 text-purple-600 focus:ring-purple-500"
                  onchange="calculateCheckboxTotal()">
                <div class="flex-1">
                  <p class="font-medium" style="font-size: ${baseSize}px; color: ${textColor};">${item.name}</p>
                  <p class="opacity-60 mt-1" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${item.points} poin</p>
                </div>
              </label>
            </div>
          `).join('')}
          <div class="p-4 rounded-lg border-2 border-purple-200 gradient-card">
            <div class="flex justify-between items-center">
              <span class="font-bold" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">Total Nilai Tercapai</span>
              <span id="checkbox-total-display" class="font-bold" style="font-size: ${baseSize * 1.5}px; color: ${primaryColor};">0 / ${criteria.maxPoints}</span>
            </div>
          </div>
        </div>
      `;
      container.classList.remove('hidden');
    }

    function calculateCheckboxTotal() {
      if (!selectedCriteriaForAssessment) return;
      
      const criteria = appState.criteria.find(c => c.__backendId === selectedCriteriaForAssessment);
      if (!criteria) return;

      const subItems = JSON.parse(criteria.subItems);
      let total = 0;

      subItems.forEach((item, index) => {
        const checkbox = document.querySelector(`input[name="subitem_${index}"]`);
        if (checkbox && checkbox.checked) {
          total += item.points;
        }
      });

      const display = document.getElementById('checkbox-total-display');
      if (display) {
        display.textContent = `${total} / ${criteria.maxPoints}`;
      }
    }

    function filterCriteriaForAssessment(query) {
      const dropdown = document.getElementById('criteria-dropdown');
      const options = dropdown.querySelectorAll('.criteria-option');
      const searchLower = query.toLowerCase();
      
      let hasVisible = false;
      options.forEach(option => {
        const name = option.dataset.name.toLowerCase();
        if (name.includes(searchLower)) {
          option.style.display = 'block';
          hasVisible = true;
        } else {
          option.style.display = 'none';
        }
      });
      
      dropdown.classList.remove('hidden');
    }

    document.addEventListener('click', function(e) {
      const techDropdown = document.getElementById('tech-dropdown');
      const techSearchInput = document.getElementById('tech-search');
      if (techDropdown && techSearchInput && !techDropdown.contains(e.target) && e.target !== techSearchInput) {
        techDropdown.classList.add('hidden');
      }

      const criteriaDropdown = document.getElementById('criteria-dropdown');
      const criteriaSearchInput = document.getElementById('criteria-search');
      if (criteriaDropdown && criteriaSearchInput && !criteriaDropdown.contains(e.target) && e.target !== criteriaSearchInput) {
        criteriaDropdown.classList.add('hidden');
      }
    });

    function renderLogin() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const appTitle = config.app_title || defaultConfig.app_title;
      const welcomeMsg = config.welcome_message || defaultConfig.welcome_message;

      return `
        <div class="min-h-full flex items-center justify-center p-4" style="background: ${bgColor}; font-family: ${customFont}, system-ui, sans-serif;">
          <div class="w-full max-w-md">
            <div class="card-hover rounded-2xl shadow-xl p-8" style="background: ${surfaceColor};">
              <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4 gradient-bg">
                  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <h1 class="font-bold mb-2" style="font-size: ${baseSize * 1.75}px; color: ${textColor}; font-family: ${customFont}, system-ui, sans-serif;">${appTitle}</h1>
                <p class="opacity-70" style="font-size: ${baseSize}px; color: ${textColor}; font-family: ${customFont}, system-ui, sans-serif;">${welcomeMsg}</p>
              </div>

              <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                  <label for="username" class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor}; font-family: ${customFont}, system-ui, sans-serif;">Username</label>
                  <input type="text" id="username" required
                    class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none transition-colors"
                    style="font-size: ${baseSize}px; font-family: ${customFont}, system-ui, sans-serif;"
                    placeholder="Masukkan username">
                </div>

                <div>
                  <label for="password" class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor}; font-family: ${customFont}, system-ui, sans-serif;">Password</label>
                  <input type="password" id="password" required
                    class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none transition-colors"
                    style="font-size: ${baseSize}px; font-family: ${customFont}, system-ui, sans-serif;"
                    placeholder="Masukkan password">
                </div>

                <button type="submit" class="w-full btn-primary text-white font-semibold py-3 px-6 rounded-lg gradient-bg"
                  style="font-size: ${baseSize}px; font-family: ${customFont}, system-ui, sans-serif;">
                  Login
                </button>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function renderAdminDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      const userCount = appState.users.length;
      const criteriaCount = appState.criteria.length;
      const assessmentCount = appState.assessments.length;

      let mainContent = '';

      if (adminActiveTab === 'dashboard') {
        mainContent = `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card-hover rounded-xl p-6" style="background: ${surfaceColor};">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                  </svg>
                </div>
                <div>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Total User</p>
                  <p class="font-bold" style="font-size: ${baseSize * 1.75}px; color: ${textColor};">${userCount}</p>
                </div>
              </div>
            </div>

            <div class="card-hover rounded-xl p-6" style="background: ${surfaceColor};">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                </div>
                <div>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Kriteria</p>
                  <p class="font-bold" style="font-size: ${baseSize * 1.75}px; color: ${textColor};">${criteriaCount}</p>
                </div>
              </div>
            </div>

            <div class="card-hover rounded-xl p-6" style="background: ${surfaceColor};">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Penilaian</p>
                  <p class="font-bold" style="font-size: ${baseSize * 1.75}px; color: ${textColor};">${assessmentCount}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="rounded-xl p-6" style="background: ${surfaceColor};">
            <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Ringkasan Sistem</h3>
            <div class="space-y-3">
              <div class="flex justify-between items-center p-4 rounded-lg gradient-card">
                <span style="font-size: ${baseSize}px; color: ${textColor};">Supervisor</span>
                <span class="font-bold" style="font-size: ${baseSize}px; color: ${primaryColor};">${appState.users.filter(u => u.role === 'supervisor').length}</span>
              </div>
              <div class="flex justify-between items-center p-4 rounded-lg gradient-card">
                <span style="font-size: ${baseSize}px; color: ${textColor};">Teknisi</span>
                <span class="font-bold" style="font-size: ${baseSize}px; color: ${primaryColor};">${appState.technicians.length}</span>
              </div>
              <div class="flex justify-between items-center p-4 rounded-lg gradient-card">
                <span style="font-size: ${baseSize}px; color: ${textColor};">Kriteria Penilaian</span>
                <span class="font-bold" style="font-size: ${baseSize}px; color: ${primaryColor};">${criteriaCount}</span>
              </div>
            </div>
          </div>
        `;
      } else if (adminActiveTab === 'users') {
        mainContent = `
          <div class="rounded-xl p-6 space-y-4" style="background: ${surfaceColor};">
            <div class="flex justify-between items-center">
              <h3 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Daftar User (Supervisor)</h3>
              <button onclick="document.getElementById('add-user-modal').classList.remove('hidden')" 
                class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium gradient-bg"
                style="font-size: ${baseSize * 0.875}px;">
                + Tambah User
              </button>
            </div>
            
            <div class="space-y-2 max-h-96 overflow-y-auto">
              ${appState.users.filter(u => u.role !== 'teknisi').map(user => `
                <div class="flex justify-between items-center p-4 rounded-lg border-2 border-gray-100">
                  <div>
                    <p class="font-medium" style="font-size: ${baseSize}px; color: ${textColor};">${user.name}</p>
                    <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${user.role === 'admin_viewer' ? 'Admin (View Only)' : user.role} • ${user.username}</p>
                    ${user.email ? `<p class="opacity-60" style="font-size: ${baseSize * 0.75}px; color: ${textColor};">${user.email}</p>` : ''}
                  </div>
                  ${user.role !== 'admin' ? `
                    <div class="flex gap-2">
                      <button onclick="openEditUser(appState.users.find(u => u.__backendId === '${user.__backendId}'))"
                        class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors"
                        style="font-size: ${baseSize * 0.875}px;">
                        Edit
                      </button>
                      <button onclick="handleDeleteUser(appState.users.find(u => u.__backendId === '${user.__backendId}'))"
                        class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors"
                        style="font-size: ${baseSize * 0.875}px;">
                        Hapus
                      </button>
                    </div>
                  ` : ''}
                </div>
              `).join('')}
              ${appState.users.filter(u => u.role !== 'teknisi').length === 0 ? `<p class="text-center opacity-60 py-8" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada user</p>` : ''}
            </div>
          </div>
        `;
      } else if (adminActiveTab === 'technicians') {
        mainContent = `
          <div class="rounded-xl p-6 space-y-4" style="background: ${surfaceColor};">
            <div class="flex justify-between items-center">
              <h3 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Daftar Teknisi</h3>
              <button onclick="document.getElementById('add-technician-modal').classList.remove('hidden')" 
                class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium gradient-bg"
                style="font-size: ${baseSize * 0.875}px;">
                + Tambah Teknisi
              </button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b-2 border-gray-200">
                    <th class="text-center p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">No</th>
                    <th class="text-left p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Nama</th>
                    <th class="text-left p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Username</th>
                    <th class="text-left p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">NIK</th>
                    <th class="text-left p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Email</th>
                    <th class="text-left p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Grup</th>
                    <th class="text-left p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Jabatan</th>
                    <th class="text-center p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  ${appState.technicians.map((tech, index) => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                      <td class="p-3 text-center font-semibold" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${index + 1}</td>
                      <td class="p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.name}</td>
                      <td class="p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.username}</td>
                      <td class="p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.nik || '-'}</td>
                      <td class="p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.email || '-'}</td>
                      <td class="p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.group || '-'}</td>
                      <td class="p-3" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.position || '-'}</td>
                      <td class="p-3 text-center">
                        <div class="flex justify-center gap-2">
                          <button onclick="openEditTechnician(appState.users.find(u => u.__backendId === '${tech.__backendId}'))"
                            class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors"
                            style="font-size: ${baseSize * 0.75}px;">
                            Edit
                          </button>
                          <button onclick="handleDeleteUser(appState.users.find(u => u.__backendId === '${tech.__backendId}'))"
                            class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors"
                            style="font-size: ${baseSize * 0.75}px;">
                            Hapus
                          </button>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                  ${appState.technicians.length === 0 ? `
                    <tr>
                      <td colspan="7" class="text-center opacity-60 py-8" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada teknisi</td>
                    </tr>
                  ` : ''}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } else if (adminActiveTab === 'criteria') {
        mainContent = `
          <div class="rounded-xl p-6 space-y-4" style="background: ${surfaceColor};">
            <div class="flex justify-between items-center">
              <h3 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Daftar Kriteria Penilaian</h3>
              <button onclick="document.getElementById('add-criteria-modal').classList.remove('hidden'); renderSubItemsList();"
                class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium gradient-bg"
                style="font-size: ${baseSize * 0.875}px;">
                + Tambah Kriteria
              </button>
            </div>
            
            <div class="space-y-3">
              ${appState.criteria.map(criteria => {
                const subItems = criteria.subItems ? JSON.parse(criteria.subItems) : [];
                return `
                  <div class="p-4 rounded-lg border-2 border-gray-100">
                    <div class="flex justify-between items-start mb-3">
                      <div class="flex-1">
                        <p class="font-bold" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">${criteria.criteriaName}</p>
                        <p class="opacity-60 mt-1" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Maksimal: ${criteria.maxPoints} poin</p>
                        ${criteria.description ? `<p class="opacity-70 mt-2" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${criteria.description}</p>` : ''}
                      </div>
                      <div class="flex gap-2">
                        <button onclick="openEditCriteria(appState.criteria.find(c => c.__backendId === '${criteria.__backendId}'))"
                          class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm transition-colors"
                          style="font-size: ${baseSize * 0.875}px;">
                          Edit
                        </button>
                        <button onclick="handleDeleteCriteria(appState.criteria.find(c => c.__backendId === '${criteria.__backendId}'))"
                          class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors"
                          style="font-size: ${baseSize * 0.875}px;">
                          Hapus
                        </button>
                      </div>
                    </div>
                    ${subItems.length > 0 ? `
                      <div class="mt-3 pt-3 border-t border-gray-200 space-y-1">
                        <p class="font-semibold mb-2" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Sub-Item Penilaian:</p>
                        ${subItems.map(item => `
                          <div class="flex justify-between items-center opacity-70 ml-4">
                            <span style="font-size: ${baseSize * 0.75}px; color: ${textColor};">• ${item.name}</span>
                            <span style="font-size: ${baseSize * 0.75}px; color: ${textColor};">${item.points} poin</span>
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
              ${criteriaCount === 0 ? `<p class="text-center opacity-60 py-8" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada kriteria</p>` : ''}
            </div>
          </div>
        `;
      } else if (adminActiveTab === 'assessments') {
        mainContent = `
          <div class="rounded-xl p-6 space-y-4" style="background: ${surfaceColor};">
            <div class="flex justify-between items-center">
              <h3 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">History Penilaian</h3>
              ${assessmentCount > 0 ? `
                <button onclick="downloadPDF()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors" style="font-size: ${baseSize * 0.875}px;">
                  📄 Download PDF
                </button>
              ` : ''}
            </div>
            
            <div class="space-y-3 max-h-96 overflow-y-auto">
              ${appState.assessments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(assessment => {
                const technician = appState.users.find(u => u.__backendId === assessment.technicianId);
                const percentage = Math.round((assessment.totalScore / assessment.maxPossible) * 100);
                const checkedItems = assessment.checkedItems ? JSON.parse(assessment.checkedItems) : [];
                
                return `
                  <div class="p-4 rounded-lg border-2 border-gray-100">
                    <div class="flex justify-between items-start mb-2">
                      <div>
                        <p class="font-semibold" style="font-size: ${baseSize}px; color: ${textColor};">${assessment.technicianName || (technician ? technician.name : 'Unknown')}</p>
                        <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Penilai: ${assessment.supervisorName}</p>
                        ${assessment.criteriaName ? `<p class="opacity-80 mt-1" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">📋 ${assessment.criteriaName}</p>` : ''}
                      </div>
                      <div class="text-right">
                        <p class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${primaryColor};">${assessment.totalScore}/${assessment.maxPossible}</p>
                        <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${percentage}%</p>
                      </div>
                    </div>
                    ${checkedItems.length > 0 ? `
                      <div class="mt-3 pt-3 border-t border-gray-100 space-y-1">
                        ${checkedItems.map(item => `
                          <div class="flex justify-between items-center text-sm opacity-70">
                            <span style="font-size: ${baseSize * 0.75}px; color: ${textColor};">
                              ${item.checked ? '✓' : '✗'} ${item.name}
                            </span>
                            <span style="font-size: ${baseSize * 0.75}px; color: ${textColor};">${item.checked ? item.points : 0}/${item.points}</span>
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                      <p class="opacity-60" style="font-size: ${baseSize * 0.75}px; color: ${textColor};">${new Date(assessment.createdAt).toLocaleString('id-ID')}</p>
                      <button onclick="handleDeleteAssessment(appState.assessments.find(a => a.__backendId === '${assessment.__backendId}'))"
                        class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors"
                        style="font-size: ${baseSize * 0.75}px;">
                        Hapus
                      </button>
                    </div>
                  </div>
                `;
              }).join('')}
              ${assessmentCount === 0 ? `<p class="text-center opacity-60 py-8" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada penilaian</p>` : ''}
            </div>
          </div>
        `;
      }

      const sidebarWidth = sidebarCollapsed ? '0' : '256px';
      
      return `
        <div class="min-h-full flex" style="background: ${bgColor}; font-family: ${customFont}, system-ui, sans-serif;">
          <!-- Sidebar -->
          <div class="shadow-lg sidebar-fixed transition-all duration-300" style="background: ${surfaceColor}; width: ${sidebarWidth}; ${sidebarCollapsed ? 'overflow: hidden;' : ''}">
            <div class="p-6 border-b border-gray-200" style="width: 256px;">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                  </svg>
                </div>
                <div>
                  <h1 class="font-bold" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">Admin Panel</h1>
                  <p class="opacity-60 text-sm" style="color: ${textColor};">${appState.currentUser.name}</p>
                </div>
              </div>
            </div>
            
            <nav class="p-4 space-y-2">
              <button onclick="adminActiveTab = 'dashboard'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${adminActiveTab === 'dashboard' ? 'font-semibold gradient-bg text-white' : ''}" style="${adminActiveTab === 'dashboard' ? '' : 'color: ' + textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Dashboard</span>
              </button>
              
              <button onclick="adminActiveTab = 'users'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${adminActiveTab === 'users' ? 'font-semibold gradient-bg text-white' : ''}" style="${adminActiveTab === 'users' ? '' : 'color: ' + textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Manajemen User</span>
              </button>
              
              <button onclick="adminActiveTab = 'technicians'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${adminActiveTab === 'technicians' ? 'font-semibold gradient-bg text-white' : ''}" style="${adminActiveTab === 'technicians' ? '' : 'color: ' + textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Manajemen Teknisi</span>
              </button>
              
              <button onclick="adminActiveTab = 'criteria'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${adminActiveTab === 'criteria' ? 'font-semibold gradient-bg text-white' : ''}" style="${adminActiveTab === 'criteria' ? '' : 'color: ' + textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Manajemen Kriteria</span>
              </button>
              
              <button onclick="adminActiveTab = 'assessments'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${adminActiveTab === 'assessments' ? 'font-semibold gradient-bg text-white' : ''}" style="${adminActiveTab === 'assessments' ? '' : 'color: ' + textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">History Penilaian</span>
              </button>
            </nav>
            
            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-200">
              <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-red-50 hover:bg-red-100 transition-colors" style="color: #ef4444;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Logout</span>
              </button>
            </div>
          </div>

          <!-- Main Content -->
          <div class="flex-1 overflow-y-auto transition-all duration-300" style="margin-left: ${sidebarWidth};">
            <div class="shadow-sm" style="background: ${surfaceColor};">
              <div class="px-8 py-4 flex items-center gap-4">
                <button onclick="sidebarCollapsed = !sidebarCollapsed; render();" class="w-10 h-10 rounded-lg flex items-center justify-center hover:bg-gray-100 transition-colors">
                  <svg class="w-6 h-6" style="color: ${textColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                  </svg>
                </button>
                <h2 class="font-bold" style="font-size: ${baseSize * 1.5}px; color: ${textColor};">
                  ${adminActiveTab === 'dashboard' ? 'Dashboard' : 
                    adminActiveTab === 'users' ? 'Manajemen User' : 
                    adminActiveTab === 'technicians' ? 'Manajemen Teknisi' :
                    adminActiveTab === 'criteria' ? 'Manajemen Kriteria' : 'History Penilaian'}
                </h2>
              </div>
            </div>

            <div class="p-8">
              ${mainContent}
            </div>
          </div>

          <!-- Edit User Modal -->
          <div id="edit-user-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="w-full max-w-md rounded-xl p-6" style="background: ${surfaceColor};">
              <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Edit User</h3>
              <form onsubmit="handleEditUser(event)" class="space-y-4">
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Nama Lengkap</label>
                  <input type="text" name="name" id="edit-user-name" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Username</label>
                  <input type="text" name="username" id="edit-user-username" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Password Baru (Opsional)</label>
                  <input type="password" name="password" class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;" placeholder="Kosongkan jika tidak diubah">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Role</label>
                  <select name="role" id="edit-user-role" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                    <option value="supervisor">Supervisor</option>
                    <option value="admin_viewer">Admin (View Only)</option>
                  </select>
                </div>
                <div class="flex gap-2">
                  <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg font-medium gradient-bg" style="font-size: ${baseSize}px;">
                    Update
                  </button>
                  <button type="button" onclick="document.getElementById('edit-user-modal').classList.add('hidden'); editingUser = null;" class="flex-1 bg-gray-200 py-2 rounded-lg font-medium" style="font-size: ${baseSize}px; color: ${textColor};">
                    Batal
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Add User Modal -->
          <div id="add-user-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="w-full max-w-md rounded-xl p-6" style="background: ${surfaceColor};">
              <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Tambah User Baru</h3>
              <form onsubmit="handleAddUser(event)" class="space-y-4">
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Nama Lengkap</label>
                  <input type="text" name="name" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Username</label>
                  <input type="text" name="username" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Password</label>
                  <input type="password" name="password" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Role</label>
                  <select name="role" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                    <option value="supervisor">Supervisor</option>
                    <option value="admin_viewer">Admin (View Only)</option>
                  </select>
                </div>
                <div class="flex gap-2">
                  <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg font-medium gradient-bg" style="font-size: ${baseSize}px;">
                    Simpan
                  </button>
                  <button type="button" onclick="document.getElementById('add-user-modal').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded-lg font-medium" style="font-size: ${baseSize}px; color: ${textColor};">
                    Batal
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Add Technician Modal -->
          <div id="add-technician-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="w-full max-w-2xl rounded-xl p-6" style="background: ${surfaceColor};">
              <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Tambah Teknisi Baru</h3>
              <form onsubmit="handleAddTechnician(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Nama Lengkap *</label>
                    <input type="text" name="name" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Username *</label>
                    <input type="text" name="username" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Password *</label>
                    <input type="password" name="password" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">NIK *</label>
                    <input type="text" name="nik" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Email *</label>
                    <input type="email" name="email" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Grup *</label>
                    <input type="text" name="group" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;" placeholder="Contoh: Tim A, Bengkel 1">
                  </div>
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Jabatan *</label>
                  <input type="text" name="position" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;" placeholder="Contoh: Teknisi Senior">
                </div>
                <div class="flex gap-2">
                  <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg font-medium gradient-bg" style="font-size: ${baseSize}px;">
                    Simpan
                  </button>
                  <button type="button" onclick="document.getElementById('add-technician-modal').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded-lg font-medium" style="font-size: ${baseSize}px; color: ${textColor};">
                    Batal
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Edit Technician Modal -->
          <div id="edit-technician-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="w-full max-w-2xl rounded-xl p-6" style="background: ${surfaceColor};">
              <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Edit Teknisi</h3>
              <form onsubmit="handleEditTechnician(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Nama Lengkap *</label>
                    <input type="text" name="name" id="edit-tech-name" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Username *</label>
                    <input type="text" name="username" id="edit-tech-username" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Password Baru (Opsional)</label>
                    <input type="password" name="password" class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;" placeholder="Kosongkan jika tidak diubah">
                  </div>
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">NIK *</label>
                    <input type="text" name="nik" id="edit-tech-nik" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Email *</label>
                    <input type="email" name="email" id="edit-tech-email" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                  <div>
                    <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Grup *</label>
                    <input type="text" name="group" id="edit-tech-group" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                  </div>
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Jabatan *</label>
                  <input type="text" name="position" id="edit-tech-position" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                </div>
                <div class="flex gap-2">
                  <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg font-medium gradient-bg" style="font-size: ${baseSize}px;">
                    Update
                  </button>
                  <button type="button" onclick="document.getElementById('edit-technician-modal').classList.add('hidden'); editingTechnician = null;" class="flex-1 bg-gray-200 py-2 rounded-lg font-medium" style="font-size: ${baseSize}px; color: ${textColor};">
                    Batal
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Add Criteria Modal -->
          <div id="add-criteria-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="w-full max-w-2xl rounded-xl p-6 max-h-screen overflow-y-auto" style="background: ${surfaceColor};">
              <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Tambah Kriteria Baru</h3>
              <form onsubmit="handleAddCriteria(event)" class="space-y-4">
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Nama Kriteria</label>
                  <input type="text" name="criteriaName" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;" placeholder="Contoh: Cek dan Setting Brake">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Deskripsi (Opsional)</label>
                  <textarea name="description" rows="2" class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none resize-none" style="font-size: ${baseSize}px;"></textarea>
                </div>
                
                <div class="border-t-2 border-gray-200 pt-4">
                  <h4 class="font-semibold mb-3" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">Tambah Sub-Item Penilaian</h4>
                  <div class="flex gap-2 mb-4">
                    <input type="text" id="sub-item-name" placeholder="Nama sub-item" class="flex-1 px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                    <input type="number" id="sub-item-points" placeholder="Poin" min="1" max="10" class="w-24 px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                    <button type="button" onclick="addSubItem()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" style="font-size: ${baseSize * 0.875}px;">
                      + Tambah
                    </button>
                  </div>
                  
                  <div id="sub-items-list" class="space-y-2">
                  </div>
                </div>
                
                <div class="flex gap-2 pt-4">
                  <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg font-medium gradient-bg" style="font-size: ${baseSize}px;">
                    Simpan Kriteria
                  </button>
                  <button type="button" onclick="document.getElementById('add-criteria-modal').classList.add('hidden'); tempSubItems = [];" class="flex-1 bg-gray-200 py-2 rounded-lg font-medium" style="font-size: ${baseSize}px; color: ${textColor};">
                    Batal
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Edit Criteria Modal -->
          <div id="edit-criteria-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center p-4 z-50">
            <div class="w-full max-w-2xl rounded-xl p-6 max-h-screen overflow-y-auto" style="background: ${surfaceColor};">
              <h3 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Edit Kriteria</h3>
              <form onsubmit="handleEditCriteria(event)" class="space-y-4">
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Nama Kriteria</label>
                  <input type="text" name="criteriaName" id="edit-criteria-name" required class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                </div>
                <div>
                  <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Deskripsi (Opsional)</label>
                  <textarea name="description" id="edit-criteria-description" rows="2" class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none resize-none" style="font-size: ${baseSize}px;"></textarea>
                </div>
                
                <div class="border-t-2 border-gray-200 pt-4">
                  <h4 class="font-semibold mb-3" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">Edit Sub-Item Penilaian</h4>
                  <div class="flex gap-2 mb-4">
                    <input type="text" id="edit-sub-item-name" placeholder="Nama sub-item" class="flex-1 px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                    <input type="number" id="edit-sub-item-points" placeholder="Poin" min="1" max="10" class="w-24 px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" style="font-size: ${baseSize}px;">
                    <button type="button" onclick="addEditSubItem()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" style="font-size: ${baseSize * 0.875}px;">
                      + Tambah
                    </button>
                  </div>
                  
                  <div id="edit-sub-items-list" class="space-y-2">
                  </div>
                </div>
                
                <div class="flex gap-2 pt-4">
                  <button type="submit" class="flex-1 btn-primary text-white py-2 rounded-lg font-medium gradient-bg" style="font-size: ${baseSize}px;">
                    Update Kriteria
                  </button>
                  <button type="button" onclick="document.getElementById('edit-criteria-modal').classList.add('hidden'); editingCriteria = null; editTempSubItems = [];" class="flex-1 bg-gray-200 py-2 rounded-lg font-medium" style="font-size: ${baseSize}px; color: ${textColor};">
                    Batal
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    function renderSupervisorDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      const myAssessments = appState.assessments.filter(a => a.supervisorId === appState.currentUser.__backendId);

      let mainContent = '';

      if (supervisorActiveTab === 'dashboard') {
        mainContent = `
          <div class="card-hover rounded-xl p-6 mb-6" style="background: ${surfaceColor};">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <div>
                <h2 class="font-bold mb-2" style="font-size: ${baseSize * 1.5}px; color: ${textColor};">Buat Penilaian Baru</h2>
                <p class="opacity-70" style="font-size: ${baseSize}px; color: ${textColor};">Nilai performa teknisi berdasarkan kriteria yang telah ditentukan</p>
              </div>
              <button onclick="appState.currentView = 'create-assessment'; render();" 
                class="btn-primary text-white px-6 py-3 rounded-lg font-semibold whitespace-nowrap gradient-bg"
                style="font-size: ${baseSize}px;">
                ✏️ Mulai Menilai
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="card-hover rounded-xl p-6" style="background: ${surfaceColor};">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Penilaian Saya</p>
                  <p class="font-bold" style="font-size: ${baseSize * 1.75}px; color: ${textColor};">${myAssessments.length}</p>
                </div>
              </div>
            </div>

            <div class="card-hover rounded-xl p-6" style="background: ${surfaceColor};">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                </div>
                <div>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Total Teknisi</p>
                  <p class="font-bold" style="font-size: ${baseSize * 1.75}px; color: ${textColor};">${appState.technicians.length}</p>
                </div>
              </div>
            </div>

            <div class="card-hover rounded-xl p-6" style="background: ${surfaceColor};">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                  </svg>
                </div>
                <div>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Kriteria</p>
                  <p class="font-bold" style="font-size: ${baseSize * 1.75}px; color: ${textColor};">${appState.criteria.length}</p>
                </div>
              </div>
            </div>
          </div>
        `;
      } else if (supervisorActiveTab === 'assessments') {
        mainContent = `
          <div class="rounded-xl p-6 space-y-4" style="background: ${surfaceColor};">
            <h3 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">History Penilaian Saya</h3>
            
            <div class="space-y-3 max-h-96 overflow-y-auto">
              ${myAssessments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(assessment => {
                const technician = appState.users.find(u => u.__backendId === assessment.technicianId);
                const percentage = Math.round((assessment.totalScore / assessment.maxPossible) * 100);
                const checkedItems = assessment.checkedItems ? JSON.parse(assessment.checkedItems) : [];
                
                return `
                  <div class="p-4 rounded-lg border-2 border-gray-100">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <p class="font-semibold" style="font-size: ${baseSize}px; color: ${textColor};">${assessment.technicianName || (technician ? technician.name : 'Unknown')}</p>
                        <p class="opacity-60 mt-1" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${new Date(assessment.createdAt).toLocaleString('id-ID')}</p>
                        ${assessment.criteriaName ? `<p class="opacity-80 mt-1" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">📋 ${assessment.criteriaName}</p>` : ''}
                        ${checkedItems.length > 0 ? `
                          <div class="mt-2 space-y-1">
                            ${checkedItems.map(item => `
                              <div class="flex justify-between items-center text-sm opacity-70">
                                <span style="font-size: ${baseSize * 0.75}px; color: ${textColor};">
                                  ${item.checked ? '✓' : '✗'} ${item.name}
                                </span>
                                <span style="font-size: ${baseSize * 0.75}px; color: ${textColor};">${item.checked ? item.points : 0}/${item.points}</span>
                              </div>
                            `).join('')}
                          </div>
                        ` : ''}
                        ${assessment.notes ? `<p class="mt-2 opacity-80" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Catatan: ${assessment.notes}</p>` : ''}
                      </div>
                      <div class="text-right">
                        <p class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${primaryColor};">${assessment.totalScore}/${assessment.maxPossible}</p>
                        <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${percentage}%</p>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
              ${myAssessments.length === 0 ? `
                <div class="text-center py-12">
                  <svg class="w-16 h-16 mx-auto opacity-20 mb-4" style="color: ${textColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <p class="opacity-60" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada penilaian yang dibuat</p>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      const sidebarWidth = sidebarCollapsed ? '0' : '256px';
      
      return `
        <div class="min-h-full flex" style="background: ${bgColor}; font-family: ${customFont}, system-ui, sans-serif;">
          <!-- Sidebar -->
          <div class="shadow-lg sidebar-fixed transition-all duration-300" style="background: ${surfaceColor}; width: ${sidebarWidth}; ${sidebarCollapsed ? 'overflow: hidden;' : ''}">
            <div class="p-6 border-b border-gray-200" style="width: 256px;">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                  </svg>
                </div>
                <div>
                  <h1 class="font-bold" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">Supervisor</h1>
                  <p class="opacity-60 text-sm" style="color: ${textColor};">${appState.currentUser.name}</p>
                </div>
              </div>
            </div>
            
            <nav class="p-4 space-y-2">
              <button onclick="supervisorActiveTab = 'dashboard'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${supervisorActiveTab === 'dashboard' ? 'font-semibold gradient-bg text-white' : ''}" style="${supervisorActiveTab === 'dashboard' ? '' : 'color: ' + textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Dashboard</span>
              </button>
              
              <button onclick="appState.currentView = 'create-assessment'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors hover:bg-gray-100" style="color: ${textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Buat Penilaian</span>
              </button>
              
              <button onclick="supervisorActiveTab = 'assessments'; render();" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${supervisorActiveTab === 'assessments' ? 'font-semibold gradient-bg text-white' : ''}" style="${supervisorActiveTab === 'assessments' ? '' : 'color: ' + textColor};">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">History Penilaian</span>
              </button>
            </nav>
            
            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-200">
              <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg bg-red-50 hover:bg-red-100 transition-colors" style="color: #ef4444;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span style="font-size: ${baseSize * 0.875}px;">Logout</span>
              </button>
            </div>
          </div>

          <!-- Main Content -->
          <div class="flex-1 overflow-y-auto transition-all duration-300" style="margin-left: ${sidebarWidth};">
            <div class="shadow-sm" style="background: ${surfaceColor};">
              <div class="px-8 py-4 flex items-center gap-4">
                <button onclick="sidebarCollapsed = !sidebarCollapsed; render();" class="w-10 h-10 rounded-lg flex items-center justify-center hover:bg-gray-100 transition-colors">
                  <svg class="w-6 h-6" style="color: ${textColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                  </svg>
                </button>
                <h2 class="font-bold" style="font-size: ${baseSize * 1.5}px; color: ${textColor};">
                  ${supervisorActiveTab === 'dashboard' ? 'Dashboard' : 'History Penilaian'}
                </h2>
              </div>
            </div>

            <div class="p-8">
              ${mainContent}
            </div>
          </div>
        </div>
      `;
    }

    function renderCreateAssessment() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      return `
        <div class="min-h-full" style="background: ${bgColor}; font-family: ${customFont}, system-ui, sans-serif;">
          <!-- Header -->
          <div class="shadow-sm" style="background: ${surfaceColor};">
            <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
              <div class="flex items-center gap-3">
                <button onclick="appState.currentView = 'supervisor-dashboard'; supervisorActiveTab = 'dashboard'; render();" class="w-10 h-10 rounded-lg flex items-center justify-center hover:bg-gray-100 transition-colors">
                  <svg class="w-6 h-6" style="color: ${textColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                </button>
                <h1 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Form Penilaian Teknisi</h1>
              </div>
            </div>
          </div>

          <div class="max-w-4xl mx-auto p-4">
            <form onsubmit="handleAddAssessment(event)" class="rounded-xl p-6 space-y-6" style="background: ${surfaceColor};">
              <!-- Technician Selection -->
              <div>
                <label class="block mb-2 font-semibold" style="font-size: ${baseSize}px; color: ${textColor};">Pilih Teknisi</label>
                <div class="relative">
                  <input type="text" id="tech-search" placeholder="Cari teknisi..." 
                    class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" 
                    style="font-size: ${baseSize}px;"
                    autocomplete="off"
                    onfocus="document.getElementById('tech-dropdown').classList.remove('hidden')"
                    oninput="filterTechnicians(this.value)">
                  <input type="hidden" name="technicianId" id="tech-id" required>
                  <div id="tech-dropdown" class="hidden absolute w-full mt-1 rounded-lg border-2 border-gray-200 max-h-60 overflow-y-auto z-10" style="background: ${surfaceColor};">
                    ${appState.technicians.map(tech => `
                      <div class="tech-option px-4 py-3 hover:bg-gray-100 cursor-pointer transition-colors" 
                        data-id="${tech.__backendId}" 
                        data-name="${tech.name}"
                        onclick="selectTechnician('${tech.__backendId}', '${tech.name.replace(/'/g, "\\'")}')">
                        <p class="font-medium" style="font-size: ${baseSize}px; color: ${textColor};">${tech.name}</p>
                        <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.position || tech.username} • ${tech.group || ''}</p>
                      </div>
                    `).join('')}
                    ${appState.technicians.length === 0 ? `
                      <div class="px-4 py-8 text-center">
                        <p class="opacity-60" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada teknisi</p>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              <!-- Criteria Selection -->
              <div>
                <label class="block mb-2 font-semibold" style="font-size: ${baseSize}px; color: ${textColor};">Pilih Kriteria Penilaian</label>
                <div class="relative">
                  <input type="text" id="criteria-search" placeholder="Cari kriteria penilaian..." 
                    class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" 
                    style="font-size: ${baseSize}px;"
                    autocomplete="off"
                    onfocus="document.getElementById('criteria-dropdown').classList.remove('hidden')"
                    oninput="filterCriteriaForAssessment(this.value)">
                  <div id="criteria-dropdown" class="hidden absolute w-full mt-1 rounded-lg border-2 border-gray-200 max-h-60 overflow-y-auto z-10" style="background: ${surfaceColor};">
                    ${appState.criteria.map(criteria => `
                      <div class="criteria-option px-4 py-3 hover:bg-gray-100 cursor-pointer transition-colors" 
                        data-name="${criteria.criteriaName}"
                        onclick="selectCriteriaForAssessment('${criteria.__backendId}')">
                        <p class="font-medium" style="font-size: ${baseSize}px; color: ${textColor};">${criteria.criteriaName}</p>
                        <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Maksimal ${criteria.maxPoints} poin</p>
                      </div>
                    `).join('')}
                    ${appState.criteria.length === 0 ? `
                      <div class="px-4 py-8 text-center">
                        <p class="opacity-60" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada kriteria</p>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              <!-- Criteria Checkboxes -->
              <div id="criteria-checkboxes-container" class="hidden">
              </div>

              <!-- Notes -->
              <div>
                <label class="block mb-2 font-semibold" style="font-size: ${baseSize}px; color: ${textColor};">Catatan (Opsional)</label>
                <textarea name="notes" rows="4" 
                  class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none resize-none" 
                  style="font-size: ${baseSize}px;"
                  placeholder="Tambahkan catatan atau feedback untuk teknisi..."></textarea>
              </div>

              <!-- Submit Buttons -->
              <div class="flex gap-3">
                <button type="submit" 
                  class="flex-1 btn-primary text-white py-3 rounded-lg font-semibold gradient-bg"
                  style="font-size: ${baseSize}px;"
                  ${appState.technicians.length === 0 || appState.criteria.length === 0 ? 'disabled' : ''}>
                  💾 Simpan Penilaian
                </button>
                <button type="button" onclick="appState.currentView = 'supervisor-dashboard'; supervisorActiveTab = 'dashboard'; selectedCriteriaForAssessment = null; render();" 
                  class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold transition-colors"
                  style="font-size: ${baseSize}px; color: ${textColor};">
                  Batal
                </button>
              </div>
            </form>
          </div>
        </div>
      `;
    }

    let adminViewerSearchTechnician = '';
    let adminViewerSearchGroup = '';

    function filterAdminViewer() {
      adminViewerSearchTechnician = document.getElementById('search-technician')?.value.toLowerCase() || '';
      adminViewerSearchGroup = document.getElementById('search-group')?.value.toLowerCase() || '';
      renderAdminViewerContent();
    }

    function renderAdminViewerDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      // Get latest assessment for each technician per criteria
      const latestAssessments = {};
      appState.technicians.forEach(tech => {
        latestAssessments[tech.__backendId] = {};
      });

      appState.assessments.forEach(assessment => {
        const techId = assessment.technicianId;
        const criteriaName = assessment.criteriaName || 'Tanpa Kriteria';
        
        if (!latestAssessments[techId]) {
          latestAssessments[techId] = {};
        }
        
        if (!latestAssessments[techId][criteriaName] || 
            new Date(assessment.createdAt) > new Date(latestAssessments[techId][criteriaName].createdAt)) {
          latestAssessments[techId][criteriaName] = assessment;
        }
      });

      // Filter technicians
      let filteredTechnicians = appState.technicians.filter(tech => {
        const matchName = tech.name.toLowerCase().includes(adminViewerSearchTechnician);
        const matchGroup = (tech.group || '').toLowerCase().includes(adminViewerSearchGroup);
        return matchName && matchGroup;
      });

      return `
        <div class="min-h-full" style="background: ${bgColor}; font-family: ${customFont}, system-ui, sans-serif;">
          <!-- Header -->
          <div class="shadow-sm" style="background: ${surfaceColor};">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                </div>
                <div>
                  <h1 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">${appState.currentUser.name}</h1>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">@${appState.currentUser.username}</p>
                </div>
              </div>
              <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors" style="font-size: ${baseSize * 0.875}px;">
                Logout
              </button>
            </div>
          </div>

          <div id="admin-viewer-content" class="max-w-7xl mx-auto p-4 space-y-6">
          </div>
        </div>
      `;
    }

    function renderAdminViewerContent() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      const latestAssessments = {};
      appState.technicians.forEach(tech => {
        latestAssessments[tech.__backendId] = {};
      });

      appState.assessments.forEach(assessment => {
        const techId = assessment.technicianId;
        const criteriaName = assessment.criteriaName || 'Tanpa Kriteria';
        
        if (!latestAssessments[techId]) {
          latestAssessments[techId] = {};
        }
        
        if (!latestAssessments[techId][criteriaName] || 
            new Date(assessment.createdAt) > new Date(latestAssessments[techId][criteriaName].createdAt)) {
          latestAssessments[techId][criteriaName] = assessment;
        }
      });

      let filteredTechnicians = appState.technicians.filter(tech => {
        const matchName = tech.name.toLowerCase().includes(adminViewerSearchTechnician);
        const matchGroup = (tech.group || '').toLowerCase().includes(adminViewerSearchGroup);
        return matchName && matchGroup;
      });

      const container = document.getElementById('admin-viewer-content');
      if (!container) return;

      container.innerHTML = `
        <!-- Search Filters -->
        <div class="rounded-xl p-6" style="background: ${surfaceColor};">
          <h2 class="font-bold mb-4" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">🔍 Filter Penilaian</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Cari Teknisi</label>
              <input type="text" id="search-technician" placeholder="Nama teknisi..." 
                value="${adminViewerSearchTechnician}"
                onkeyup="filterAdminViewer()"
                class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" 
                style="font-size: ${baseSize}px;">
            </div>
            <div>
              <label class="block mb-2 font-medium" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Cari Grup</label>
              <input type="text" id="search-group" placeholder="Nama grup..." 
                value="${adminViewerSearchGroup}"
                onkeyup="filterAdminViewer()"
                class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none" 
                style="font-size: ${baseSize}px;">
            </div>
          </div>
        </div>

        <!-- Latest Assessments -->
        <div class="rounded-xl p-6 space-y-6" style="background: ${surfaceColor};">
          <h2 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">📊 Penilaian Terbaru Per Teknisi</h2>
          
          ${filteredTechnicians.length > 0 ? filteredTechnicians.map(tech => {
            const techAssessments = latestAssessments[tech.__backendId] || {};
            const criteriaNames = Object.keys(techAssessments);
            
            return `
              <div class="border-2 border-gray-200 rounded-lg p-6 space-y-4">
                <div class="flex justify-between items-start pb-4 border-b-2 border-gray-100">
                  <div>
                    <h3 class="font-bold" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">👤 ${tech.name}</h3>
                    <p class="opacity-60 mt-1" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${tech.position || tech.username} • Grup: ${tech.group || '-'}</p>
                    <p class="opacity-60" style="font-size: ${baseSize * 0.75}px; color: ${textColor};">NIK: ${tech.nik || '-'} • Email: ${tech.email || '-'}</p>
                  </div>
                </div>
                
                ${criteriaNames.length > 0 ? `
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${criteriaNames.map(criteriaName => {
                      const assessment = techAssessments[criteriaName];
                      const percentage = Math.round((assessment.totalScore / assessment.maxPossible) * 100);
                      
                      return `
                        <div class="p-4 rounded-lg border-2 border-purple-100 gradient-card">
                          <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                              <p class="font-semibold mb-1" style="font-size: ${baseSize}px; color: ${textColor};">📋 ${criteriaName}</p>
                              <p class="opacity-60" style="font-size: ${baseSize * 0.75}px; color: ${textColor};">Penilai: ${assessment.supervisorName}</p>
                              <p class="opacity-60" style="font-size: ${baseSize * 0.75}px; color: ${textColor};">${new Date(assessment.createdAt).toLocaleString('id-ID')}</p>
                            </div>
                            <div class="text-right">
                              <p class="font-bold" style="font-size: ${baseSize * 1.5}px; color: ${primaryColor};">${assessment.totalScore}</p>
                              <p class="opacity-60" style="font-size: ${baseSize * 0.75}px; color: ${textColor};">dari ${assessment.maxPossible}</p>
                            </div>
                          </div>
                          <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full rounded-full gradient-bg" style="width: ${percentage}%"></div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : `
                  <div class="text-center py-8">
                    <p class="opacity-60" style="font-size: ${baseSize}px; color: ${textColor};">Belum ada penilaian untuk teknisi ini</p>
                  </div>
                `}
              </div>
            `;
          }).join('') : `
            <div class="text-center py-12">
              <svg class="w-16 h-16 mx-auto opacity-20 mb-4" style="color: ${textColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <p class="opacity-60" style="font-size: ${baseSize}px; color: ${textColor};">Tidak ada teknisi yang sesuai dengan pencarian</p>
            </div>
          `}
        </div>
      `;
    }

    function renderTeknisiDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      const myAssessments = appState.assessments
        .filter(a => a.technicianId === appState.currentUser.__backendId)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      // Group by criteria
      const assessmentsByCriteria = {};
      myAssessments.forEach(assessment => {
        const criteriaName = assessment.criteriaName || 'Tanpa Kriteria';
        if (!assessmentsByCriteria[criteriaName]) {
          assessmentsByCriteria[criteriaName] = [];
        }
        assessmentsByCriteria[criteriaName].push(assessment);
      });

      return `
        <div class="min-h-full" style="background: ${bgColor}; font-family: ${customFont}, system-ui, sans-serif;">
          <!-- Header -->
          <div class="shadow-sm" style="background: ${surfaceColor};">
            <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg flex items-center justify-center gradient-bg">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                </div>
                <div>
                  <h1 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Dashboard Teknisi</h1>
                  <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${appState.currentUser.name}</p>
                </div>
              </div>
              <button onclick="handleLogout()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">
                Logout
              </button>
            </div>
          </div>

          <div class="max-w-4xl mx-auto p-4 space-y-6">
            ${Object.keys(assessmentsByCriteria).length > 0 ? `
              <!-- Latest Scores by Criteria -->
              <div class="space-y-4">
                <h2 class="font-bold" style="font-size: ${baseSize * 1.5}px; color: ${textColor};">Nilai Terbaru Anda</h2>
                ${Object.keys(assessmentsByCriteria).map(criteriaName => {
                  const latestForCriteria = assessmentsByCriteria[criteriaName][0];
                  return `
                    <div class="card-hover rounded-xl p-6" style="background: ${surfaceColor}; border: 2px solid #e5e7eb;">
                      <div class="flex justify-between items-start mb-4">
                        <div>
                          <h3 class="font-bold mb-1" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">📋 ${criteriaName}</h3>
                          <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">Dinilai oleh: ${latestForCriteria.supervisorName}</p>
                          <p class="opacity-60" style="font-size: ${baseSize * 0.75}px; color: ${textColor};">${new Date(latestForCriteria.createdAt).toLocaleString('id-ID')}</p>
                        </div>
                        <div class="text-right">
                          <p class="font-bold" style="font-size: ${baseSize * 2.5}px; color: ${primaryColor};">${latestForCriteria.totalScore}</p>
                          <p class="opacity-60" style="font-size: ${baseSize}px; color: ${textColor};">dari ${latestForCriteria.maxPossible} poin</p>
                        </div>
                      </div>
                      <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500 gradient-bg" style="width: ${(latestForCriteria.totalScore / latestForCriteria.maxPossible) * 100}%"></div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>

              <!-- Detailed Score Breakdown -->
              <div class="rounded-xl p-6 space-y-4" style="background: ${surfaceColor};">
                <h2 class="font-bold" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Detail Penilaian</h2>
                ${Object.keys(assessmentsByCriteria).map(criteriaName => {
                  const latestForCriteria = assessmentsByCriteria[criteriaName][0];
                  const checkedItems = latestForCriteria.checkedItems ? JSON.parse(latestForCriteria.checkedItems) : [];
                  
                  return `
                    <div class="border-2 border-gray-200 rounded-lg p-4 space-y-3">
                      <div class="flex justify-between items-center pb-3 border-b-2 border-gray-100">
                        <h3 class="font-bold" style="font-size: ${baseSize * 1.125}px; color: ${textColor};">📋 ${criteriaName}</h3>
                        <p class="opacity-60" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">oleh ${latestForCriteria.supervisorName}</p>
                      </div>
                      ${checkedItems.map(item => `
                        <div class="p-3 rounded-lg ${item.checked ? 'border-2 border-green-200 bg-green-50' : 'bg-gray-50'}" style="${item.checked ? '' : 'background: ' + bgColor};">
                          <div class="flex items-center gap-3">
                            <div class="w-6 h-6 rounded flex items-center justify-center flex-shrink-0" style="background: ${item.checked ? '#10b981' : '#e5e7eb'};">
                              ${item.checked ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : ''}
                            </div>
                            <p class="font-medium flex-1" style="font-size: ${baseSize}px; color: ${textColor};">${item.name}</p>
                            <p class="font-bold" style="font-size: ${baseSize}px; color: ${item.checked ? '#10b981' : textColor};">${item.checked ? item.points : 0} / ${item.points}</p>
                          </div>
                        </div>
                      `).join('')}
                      ${latestForCriteria.notes ? `
                        <div class="p-3 rounded-lg border-2 border-blue-200" style="background: #eff6ff;">
                          <p class="font-medium mb-1" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">📝 Catatan</p>
                          <p class="opacity-80" style="font-size: ${baseSize * 0.875}px; color: ${textColor};">${latestForCriteria.notes}</p>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            ` : `
              <!-- No Assessment Yet -->
              <div class="rounded-xl p-12 text-center" style="background: ${surfaceColor};">
                <svg class="w-24 h-24 mx-auto opacity-20 mb-4" style="color: ${textColor};" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="font-bold mb-2" style="font-size: ${baseSize * 1.25}px; color: ${textColor};">Belum Ada Penilaian</h3>
                <p class="opacity-60" style="font-size: ${baseSize}px; color: ${textColor};">Anda belum memiliki penilaian dari supervisor</p>
              </div>
            `}


          </div>
        </div>
      `;
    }

    async function render() {
      const config = window.elementSdk?.config || defaultConfig;
      
      let html = '';
      
      if (appState.currentView === 'login') {
        html = renderLogin();
      } else if (appState.currentView === 'admin-dashboard') {
        html = renderAdminDashboard();
      } else if (appState.currentView === 'supervisor-dashboard') {
        html = renderSupervisorDashboard();
      } else if (appState.currentView === 'create-assessment') {
        html = renderCreateAssessment();
      } else if (appState.currentView === 'admin-viewer-dashboard') {
        html = renderAdminViewerDashboard();
        document.getElementById('app').innerHTML = html;
        renderAdminViewerContent();
        return;
      } else if (appState.currentView === 'teknisi-dashboard') {
        html = renderTeknisiDashboard();
      }
      
      document.getElementById('app').innerHTML = html;
    }

    async function onConfigChange(config) {
      render();
    }

    window.elementSdk.init({
      defaultConfig,
      onConfigChange,
      mapToCapabilities: (config) => ({
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => {
              config.primary_color = value;
              window.elementSdk.setConfig({ primary_color: value });
            }
          },
          {
            get: () => config.secondary_color || defaultConfig.secondary_color,
            set: (value) => {
              config.secondary_color = value;
              window.elementSdk.setConfig({ secondary_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      }),
      mapToEditPanelValues: (config) => new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
      ])
    });

    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a27f6dfd78fea86',t:'MTc2MzgwOTY1OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
